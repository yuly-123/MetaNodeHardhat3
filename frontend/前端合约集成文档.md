# 前端合约集成文档

本文档详细说明前端项目中如何调用智能合约，包括创建活动、筹款、提取资金等需要发送交易的操作，以及钱包连接和交易确认的流程。

## 目录

1. [钱包连接](#钱包连接)
2. [合约调用概览](#合约调用概览)
3. [创建活动](#创建活动)
4. [活动操作](#活动操作)
5. [只读操作](#只读操作)
6. [交易确认流程](#交易确认流程)
7. [错误处理](#错误处理)

---

## 钱包连接

### 文件位置
- **主要文件**: `frontend/components/Web3Provider.tsx`
- **Hook**: `frontend/hooks/useWeb3.ts`

### 连接方式

#### 1. 初始化 Provider

```typescript
// frontend/components/Web3Provider.tsx (第 63 行)
const initProvider = new ethers.BrowserProvider(window.ethereum);
```

**说明**:
- 使用 `ethers.BrowserProvider` 创建提供者
- `window.ethereum` 是 MetaMask 注入的全局对象
- 需要检查 `window.ethereum` 是否存在

#### 2. 连接钱包

```typescript
// frontend/components/Web3Provider.tsx (第 161-200 行)
const connectWallet = async () => {
  // 1. 检查 MetaMask 是否安装
  if (typeof window === 'undefined' || !window.ethereum) {
    alert('Please install MetaMask!');
    return;
  }

  // 2. 创建 Provider
  const newProvider = new ethers.BrowserProvider(window.ethereum);
  
  // 3. 检查并切换到 Sepolia 网络
  const network = await newProvider.getNetwork();
  const expectedChainId = BigInt(11155111); // Sepolia
  
  if (network.chainId !== expectedChainId) {
    await switchToSepolia(); // 自动切换网络
  }

  // 4. 请求账户访问权限
  const accounts = await newProvider.send('eth_requestAccounts', []);
  
  // 5. 获取 Signer（用于签名交易）
  const newSigner = await newProvider.getSigner();
  
  // 6. 更新状态
  setProvider(newProvider);
  setSigner(newSigner);
  setAccount(accounts[0]);
};
```

**关键点**:
- `eth_requestAccounts`: 请求用户授权访问账户（**会弹出 MetaMask 确认窗口**）
- `getSigner()`: 获取签名器，用于发送交易
- 自动检测并切换到 Sepolia 测试网

#### 3. 网络切换

```typescript
// frontend/components/Web3Provider.tsx (第 23-59 行)
const switchToSepolia = async () => {
  const sepoliaChainId = '0xaa36a7'; // 11155111 in hex
  
  try {
    // 尝试切换到 Sepolia
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: sepoliaChainId }],
    });
  } catch (switchError: any) {
    // 如果网络不存在，添加网络
    if (switchError.code === 4902) {
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: sepoliaChainId,
          chainName: 'Sepolia',
          nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['https://eth-sepolia.g.alchemy.com/v2/...'],
          blockExplorerUrls: ['https://sepolia.etherscan.io'],
        }],
      });
    }
  }
};
```

**说明**:
- `wallet_switchEthereumChain`: 切换到指定网络（**会弹出确认窗口**）
- `wallet_addEthereumChain`: 如果网络不存在，添加网络（**会弹出确认窗口**）

---

## 合约调用概览

### 核心文件

| 操作类型 | 文件位置 | Hook/组件 |
|---------|---------|----------|
| 创建活动 | `frontend/hooks/useFactory.ts` | `useFactory()` |
| 贡献资金 | `frontend/app/campaign/[address]/page.tsx` | `handleContribute()` |
| 启动活动 | `frontend/app/campaign/[address]/page.tsx` | `handleStart()` |
| 完成活动 | `frontend/app/campaign/[address]/page.tsx` | `handleFinalize()` |
| 提取资金 | `frontend/app/campaign/[address]/page.tsx` | `handleWithdraw()` |
| 申请退款 | `frontend/app/campaign/[address]/page.tsx` | `handleRefund()` |
| 查询活动列表 | `frontend/hooks/useCampaigns.ts` | `useCampaigns()` |
| 查询活动详情 | `frontend/hooks/useCampaign.ts` | `useCampaign()` |

### ABI 定义

**文件位置**: `frontend/lib/abis.ts`

包含两个合约的 ABI：
- `CrowdfundingFactoryABI`: 工厂合约 ABI
- `CrowdfundingCampaignABI`: 活动合约 ABI

---

## 创建活动

### 文件位置
- **Hook**: `frontend/hooks/useFactory.ts`
- **UI 组件**: `frontend/components/CreateCampaignModal.tsx`

### 调用流程

#### 1. 用户输入（CreateCampaignModal.tsx）

```typescript
// frontend/components/CreateCampaignModal.tsx (第 23-65 行)
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // 验证输入
  if (!signer) {
    showWarning('请先连接钱包！', '提示');
    return;
  }
  
  if (!name || !goal || !duration) {
    showWarning('请填写完整信息', '提示');
    return;
  }

  // 调用创建函数
  await createCampaign(name.trim(), goal, parseInt(duration));
};
```

#### 2. 合约调用（useFactory.ts）

```typescript
// frontend/hooks/useFactory.ts (第 11-61 行)
const createCampaign = async (
  name: string,           // 活动名称
  goal: string,           // 目标金额（ETH 字符串，如 "10.0"）
  durationInDays: number  // 持续时间（天数，1-90）
) => {
  // 1. 检查 Signer
  if (!signer) {
    throw new Error('钱包未连接，请先连接钱包');
  }

  // 2. 创建合约实例
  const factory = new ethers.Contract(
    FACTORY_ADDRESS,              // 工厂合约地址（从环境变量获取）
    CrowdfundingFactoryABI,       // 工厂合约 ABI
    signer                         // 签名器（用于发送交易）
  );

  // 3. 转换金额单位（ETH -> Wei）
  const goalWei = ethers.parseEther(goal);
  
  // 4. 调用合约方法（发送交易）
  const tx = await factory.createCampaign(
    name.trim(),    // 活动名称
    goalWei,        // 目标金额（Wei）
    durationInDays  // 持续时间（天）
  );
  
  // ⚠️ 此时会弹出 MetaMask 确认窗口
  
  // 5. 等待交易确认
  const receipt = await tx.wait();
  
  return receipt;
};
```

### 合约方法签名

```solidity
// CrowdfundingFactory.sol
function createCampaign(
    string memory _name,
    uint256 _goal,
    uint256 _durationInDays
) external returns (address)
```

### 参数说明

| 参数 | 类型 | 说明 | 示例 |
|-----|------|------|------|
| `name` | `string` | 活动名称 | `"帮助贫困学生"` |
| `goal` | `string` | 目标金额（ETH） | `"10.0"` |
| `goalWei` | `bigint` | 目标金额（Wei） | `ethers.parseEther("10.0")` |
| `durationInDays` | `number` | 持续时间（天） | `7` |

### 环境变量

```env
# frontend/.env.local
NEXT_PUBLIC_FACTORY_ADDRESS=0x你的工厂合约地址
```

---

## 活动操作

### 文件位置
`frontend/app/campaign/[address]/page.tsx`

### 1. 贡献资金（Contribute）

#### 调用代码

```typescript
// frontend/app/campaign/[address]/page.tsx (第 31-117 行)
const handleContribute = async () => {
  // 1. 验证账户和金额
  if (!account) {
    showWarning('请先连接钱包！', '提示');
    return;
  }
  
  if (!contributeAmount || parseFloat(contributeAmount) <= 0) {
    showWarning('请输入有效的贡献金额', '提示');
    return;
  }

  // 2. 获取 Signer
  let currentSigner = signer;
  if (!currentSigner && provider) {
    currentSigner = await provider.getSigner();
  }

  // 3. 创建合约实例
  const campaignContract = new ethers.Contract(
    address,                    // 活动合约地址
    CrowdfundingCampaignABI,    // 活动合约 ABI
    currentSigner               // 签名器
  );

  // 4. 转换金额（ETH -> Wei）
  const value = ethers.parseEther(contributeAmount);
  
  // 5. 调用合约方法（发送交易 + ETH）
  const tx = await campaignContract.contribute({
    value: value,  // 发送的 ETH 金额（Wei）
  });
  
  // 注意：此时会弹出 MetaMask 确认窗口（包括金额和 Gas 费用）
  
  // 6. 等待交易确认
  const receipt = await tx.wait();
  
  // 7. 刷新数据
  await refresh();
};
```

#### 合约方法签名

```solidity
// CrowdfundingCampaign.sol
function contribute() external payable
```

#### 参数说明

| 参数 | 类型 | 说明 | 示例 |
|-----|------|------|------|
| `value` | `bigint` | 贡献的 ETH 金额（Wei） | `ethers.parseEther("0.1")` |

**注意**: `contribute()` 是 `payable` 函数，需要发送 ETH。

---

### 2. 启动活动（Start）

#### 调用代码

```typescript
// frontend/app/campaign/[address]/page.tsx (第 168-187 行)
const handleStart = async () => {
  if (!signer) {
    showWarning('请先连接钱包！', '提示');
    return;
  }

  try {
    setIsStarting(true);
    setUserInteracting(true);
    
    // 创建合约实例
    const campaignContract = new ethers.Contract(
      address,
      CrowdfundingCampaignABI,
      signer
    );

    // 调用合约方法
    const tx = await campaignContract.start();
    
    // 注意：弹出 MetaMask 确认窗口
    
    // 等待交易确认
    await tx.wait();
    
    await refresh();
    showSuccess('活动启动成功！', '成功');
  } catch (error: any) {
    showError(error.message || '启动失败', '错误');
  } finally {
    setIsStarting(false);
    setUserInteracting(false);
  }
};
```

#### 合约方法签名

```solidity
// CrowdfundingCampaign.sol
function start() external
```

**权限**: 仅活动创建者（owner）可调用。

---

### 3. 完成活动（Finalize）

#### 调用代码

```typescript
// frontend/app/campaign/[address]/page.tsx (第 189-210 行)
const handleFinalize = async () => {
  if (!signer) {
    showWarning('请先连接钱包！', '提示');
    return;
  }

  try {
    setIsFinalizing(true);
    setUserInteracting(true);
    
    const campaignContract = new ethers.Contract(
      address,
      CrowdfundingCampaignABI,
      signer
    );

    const tx = await campaignContract.finalize();
    
    // 注意：弹出 MetaMask 确认窗口
    
    await tx.wait();
    
    await refresh();
    showSuccess('活动已成功完成！', '成功');
  } catch (error: any) {
    showError(`完成失败: ${error.message}`, '错误');
  } finally {
    setIsFinalizing(false);
    setUserInteracting(false);
  }
};
```

#### 合约方法签名

```solidity
// CrowdfundingCampaign.sol
function finalize() external
```

**条件**: 活动必须处于 `Active` 状态且已过期。

---

### 4. 提取资金（Withdraw）

#### 调用代码

```typescript
// frontend/app/campaign/[address]/page.tsx (第 119-144 行)
const handleWithdraw = async () => {
  if (!signer) return;

  try {
    setIsWithdrawing(true);
    setUserInteracting(true);
    
    const campaignContract = new ethers.Contract(
      address,
      CrowdfundingCampaignABI,
      signer
    );

    const tx = await campaignContract.withdraw();
    
    // 注意：弹出 MetaMask 确认窗口
    
    await tx.wait();
    
    await refresh();
    showSuccess('资金提取成功！', '成功');
  } catch (error: any) {
    showError(error.message || '提取失败', '错误');
  } finally {
    setIsWithdrawing(false);
    setUserInteracting(false);
  }
};
```

#### 合约方法签名

```solidity
// CrowdfundingCampaign.sol
function withdraw() external
```

**权限**: 仅活动创建者（owner）可调用。  
**条件**: 活动必须处于 `Success` 状态。

---

### 5. 申请退款（Refund）

#### 调用代码

```typescript
// frontend/app/campaign/[address]/page.tsx (第 146-167 行)
const handleRefund = async () => {
  if (!signer) return;

  try {
    setIsRefunding(true);
    setUserInteracting(true);
    
    const campaignContract = new ethers.Contract(
      address,
      CrowdfundingCampaignABI,
      signer
    );

    const tx = await campaignContract.refund();
    
    // 注意：弹出 MetaMask 确认窗口
    
    await tx.wait();
    
    await refresh();
    showSuccess('退款成功！', '成功');
  } catch (error: any) {
    showError(error.message || '退款失败', '错误');
  } finally {
    setIsRefunding(false);
    setUserInteracting(false);
  }
};
```

#### 合约方法签名

```solidity
// CrowdfundingCampaign.sol
function refund() external
```

**条件**: 活动必须处于 `Failed` 状态，且用户有贡献记录。

---

## 只读操作

### 1. 查询活动列表

#### 文件位置
`frontend/hooks/useCampaigns.ts`

#### 调用代码

```typescript
// frontend/hooks/useCampaigns.ts
const fetchCampaigns = useCallback(async () => {
  if (!provider || !FACTORY_ADDRESS) return;

  // 1. 创建工厂合约实例（只读，不需要 signer）
  const factory = new ethers.Contract(
    FACTORY_ADDRESS,
    CrowdfundingFactoryABI,
    provider  // 使用 provider，不是 signer
  );

  // 2. 调用只读方法（不需要发送交易）
  const addresses = await factory.getCampaigns();
  
  // 3. 遍历每个活动地址，获取详细信息
  const campaignPromises = addresses.map(async (address: string) => {
    const campaign = new ethers.Contract(
      address,
      CrowdfundingCampaignABI,
      provider
    );

    // 调用多个只读方法
    const [owner, name, goal, deadline, totalRaised, state, contributorCount] = 
      await Promise.all([
        campaign.owner(),
        campaign.name(),
        campaign.goal(),
        campaign.deadline(),
        campaign.totalRaised(),
        campaign.state(),
        campaign.getContributorCount(),
      ]);

    return {
      address,
      owner,
      name,
      goal,
      totalRaised,
      deadline,
      state: Number(state),
      contributorCount: Number(contributorCount),
    };
  });

  const campaignData = await Promise.all(campaignPromises);
  setCampaigns(campaignData);
}, [provider]);
```

**说明**:
- 使用 `provider` 而不是 `signer`（只读操作）
- 不需要发送交易，不会弹出 MetaMask 确认窗口
- 可以批量调用多个方法（使用 `Promise.all`）

---

### 2. 查询活动详情

#### 文件位置
`frontend/hooks/useCampaign.ts`

#### 调用代码

```typescript
// frontend/hooks/useCampaign.ts
const fetchCampaign = useCallback(async () => {
  if (!provider || !address) return;

  const campaignContract = new ethers.Contract(
    address,
    CrowdfundingCampaignABI,
    provider  // 只读，使用 provider
  );

  // 批量查询多个字段
  const [owner, name, goal, deadline, totalRaised, state, contributorCount, userContribution] = 
    await Promise.all([
      campaignContract.owner(),
      campaignContract.name(),
      campaignContract.goal(),
      campaignContract.deadline(),
      campaignContract.totalRaised(),
      campaignContract.state(),
      campaignContract.getContributorCount(),
      account ? campaignContract.contributions(account).catch(() => 0n) : Promise.resolve(0n),
    ]);

  setCampaign({
    address,
    owner,
    name,
    goal,
    totalRaised,
    deadline,
    state: Number(state),
    contributorCount: Number(contributorCount),
    userContribution,
  });
}, [provider, address, account]);
```

---

## 交易确认流程

### 完整流程

1. **用户操作** → 点击按钮（如"创建活动"、"贡献资金"）
2. **验证输入** → 检查账户、金额、权限等
3. **创建合约实例** → `new ethers.Contract(address, ABI, signer)`
4. **调用合约方法** → `await contract.methodName(params)`
5. **MetaMask 弹出确认窗口** → 用户查看交易详情并确认
6. **等待交易确认** → `await tx.wait()`
7. **更新 UI** → 刷新数据、显示成功提示

### MetaMask 确认窗口

当调用需要发送交易的方法时，MetaMask 会自动弹出确认窗口，显示：

- **交易类型**: 合约交互
- **金额**: 如果是 `payable` 函数，显示发送的 ETH 金额
- **Gas 费用**: 预估的 Gas 费用
- **合约地址**: 被调用的合约地址
- **方法名称**: 调用的合约方法
- **参数**: 方法参数（如果有）

### 代码示例

```typescript
// 1. 创建合约实例（使用 signer）
const contract = new ethers.Contract(
  contractAddress,
  contractABI,
  signer  // 注意：必须使用 signer，不能使用 provider
);

// 2. 调用方法（发送交易）
const tx = await contract.methodName(param1, param2, {
  value: ethers.parseEther("0.1"),  // 如果是 payable 函数，需要 value
});

// 注意：此时 MetaMask 会弹出确认窗口
// 用户可以选择：
// - 确认：交易被发送到网络
// - 拒绝：抛出 ACTION_REJECTED 错误

// 3. 等待交易确认
const receipt = await tx.wait();
// receipt 包含交易收据信息：
// - receipt.hash: 交易哈希
// - receipt.blockNumber: 区块号
// - receipt.status: 交易状态（1=成功，0=失败）
```

### 关键区别

| 操作类型 | 使用 | 是否需要确认 | 是否消耗 Gas |
|---------|------|------------|------------|
| **只读操作** | `provider` | ❌ 否 | ❌ 否 |
| **发送交易** | `signer` | ✅ 是 | ✅ 是 |

---

## 错误处理

### 常见错误

#### 1. 用户取消交易

```typescript
try {
  const tx = await contract.methodName();
  await tx.wait();
} catch (error: any) {
  if (error.code === 'ACTION_REJECTED') {
    showError('用户取消了交易', '提示');
  }
}
```

#### 2. 余额不足

```typescript
catch (error: any) {
  if (error.code === 'INSUFFICIENT_FUNDS') {
    showError('余额不足，请确保账户有足够的 ETH', '错误');
  }
}
```

#### 3. 权限不足

```typescript
catch (error: any) {
  if (error.reason && error.reason.includes('not owner')) {
    showError('只有活动创建者可以执行此操作', '权限错误');
  }
}
```

#### 4. 状态错误

```typescript
catch (error: any) {
  if (error.reason && error.reason.includes('invalid state')) {
    showError('活动状态不允许此操作', '状态错误');
  }
}
```

### 错误处理模式

```typescript
try {
  setIsLoading(true);
  const tx = await contract.methodName();
  await tx.wait();
  showSuccess('操作成功！', '成功');
  await refresh(); // 刷新数据
} catch (error: any) {
  console.error('Error:', error);
  
  let errorMessage = '操作失败';
  
  if (error.code === 'ACTION_REJECTED') {
    errorMessage = '用户取消了交易';
  } else if (error.code === 'INSUFFICIENT_FUNDS') {
    errorMessage = '余额不足';
  } else if (error.reason) {
    errorMessage = error.reason;
  } else if (error.message) {
    errorMessage = error.message;
  }
  
  showError(errorMessage, '错误');
} finally {
  setIsLoading(false);
}
```

---

## 总结

### 发送交易的关键步骤

1. ✅ **检查 Signer**: 确保 `signer` 存在
2. ✅ **创建合约实例**: `new ethers.Contract(address, ABI, signer)`
3. ✅ **调用方法**: `await contract.methodName(params)`
4. ✅ **等待确认**: `await tx.wait()`
5. ✅ **处理错误**: 捕获并显示友好的错误信息

### 只读操作的关键步骤

1. ✅ **使用 Provider**: 使用 `provider` 而不是 `signer`
2. ✅ **创建合约实例**: `new ethers.Contract(address, ABI, provider)`
3. ✅ **调用方法**: `await contract.methodName()`（不需要等待确认）

### 环境变量

```env
# frontend/.env.local
NEXT_PUBLIC_FACTORY_ADDRESS=0x你的工厂合约地址
NEXT_PUBLIC_CHAIN_ID=11155111
NEXT_PUBLIC_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/你的API_KEY
```

---

## 参考资源

- [Ethers.js 文档](https://docs.ethers.org/)
- [MetaMask 文档](https://docs.metamask.io/)
- [Solidity 合约代码](../contracts/)

