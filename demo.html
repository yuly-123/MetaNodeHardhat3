<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ethers.js + MetaMask æ¼”ç¤º</title>
  <!-- ä½¿ç”¨å¤šä¸ª CDN æºï¼Œç¡®ä¿èƒ½åŠ è½½ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.16.0/dist/ethers.umd.min.js"></script>
  <script>
    // å¦‚æœç¬¬ä¸€ä¸ª CDN å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ CDN
    if (typeof ethers === 'undefined') {
      document.write('<script src="https://unpkg.com/ethers@6.16.0/dist/ethers.umd.min.js"><\/script>');
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border: 1px solid #e9ecef;
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h2::before {
      content: "â–¸";
      color: #764ba2;
    }

    .connect-section {
      text-align: center;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    #connectBtn {
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: inline-block;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(246, 133, 27, 0.4);
      min-width: 200px;
    }

    #connectBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(246, 133, 27, 0.6);
      background: linear-gradient(135deg, #e2761b 0%, #d66a0f 100%);
    }

    #connectBtn:active:not(:disabled) {
      transform: translateY(0);
    }

    #connectBtn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    #accountInfo {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      display: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #accountInfo.connected {
      display: block;
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      font-weight: 600;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #6c757d;
    }

    .info-value {
      font-family: 'Courier New', monospace;
      color: #667eea;
      word-break: break-all;
      text-align: right;
      max-width: 60%;
    }

    .value-display {
      font-size: 2em;
      font-weight: 700;
      color: #667eea;
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 150px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }

    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .input-group input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      transition: border-color 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    #eventLog {
      max-height: 400px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
    }

    #eventLog::-webkit-scrollbar {
      width: 8px;
    }

    #eventLog::-webkit-scrollbar-track {
      background: #2d2d2d;
      border-radius: 4px;
    }

    #eventLog::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    #eventLog::-webkit-scrollbar-thumb:hover {
      background: #764ba2;
    }

    .log-entry {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(102, 126, 234, 0.1);
      border-left: 3px solid #667eea;
      border-radius: 4px;
    }

    .log-time {
      color: #888;
      margin-right: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¦Š Ethers.js + MetaMask æ¼”ç¤º</h1>
      <p>æ™ºèƒ½åˆçº¦äº¤äº’ç•Œé¢</p>
    </div>

    <div class="content">
      <!-- é‡è¦æç¤º -->
      <div id="fileProtocolWarning" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #856404; margin-bottom: 10px;">é‡è¦æç¤º</h3>
        <p style="color: #856404; margin-bottom: 10px;">
          æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨ <code>file://</code> åè®®æ‰“å¼€é¡µé¢ã€‚MetaMask æ— æ³•åœ¨ <code>file://</code> åè®®ä¸‹å·¥ä½œï¼
        </p>
        <p style="color: #856404; margin-bottom: 15px;">
          <strong>è¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼š</strong>
        </p>
        <div style="background: white; padding: 15px; border-radius: 5px; font-family: monospace; margin-bottom: 10px;">
          <div style="margin-bottom: 5px;"><strong>æ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼š</strong></div>
          <div style="color: #28a745;">cd /Users/xxxxx/Documents/mateNodeå­¦é™¢/hardhat3å­¦ä¹ /hardhat3-demo</div>
          <div style="color: #28a745;">python3 -m http.server 8080</div>
          <div style="margin-top: 10px; margin-bottom: 5px;"><strong>ç„¶åè®¿é—®ï¼š</strong></div>
          <div style="color: #007bff;">http://localhost:8080/demo.html</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 5px; font-family: monospace;">
          <div style="margin-bottom: 5px;"><strong>æ–¹æ³•2ï¼š</strong></div>
          <div style="color: #28a745;">npx http-server -p 8080</div>
        </div>
      </div>
      
      <!-- è¿æ¥ MetaMask åŒºåŸŸ -->
      <div class="section connect-section">
        <h2>é’±åŒ…è¿æ¥</h2>
        <button id="connectBtn">è¿æ¥MetaMask</button>
        <div id="accountInfo"></div>
      </div>

      <!-- åˆçº¦ä¿¡æ¯åŒºåŸŸ -->
      <div class="section">
        <h2>åˆçº¦ä¿¡æ¯</h2>
        <div class="info-row">
          <span class="info-label">åˆçº¦åœ°å€:</span>
          <div style="flex: 1; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="contractAddressInput" 
                   value="0x5FbDB2315678afecb367f032d93F642f64180aa3" 
                   style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-family: monospace; font-size: 0.9em;"
                   placeholder="è¾“å…¥åˆçº¦åœ°å€æˆ–ç•™ç©ºè‡ªåŠ¨éƒ¨ç½²">
            <button id="verifyContractBtn" class="btn" style="padding: 8px 16px; min-width: auto;">éªŒè¯</button>
            <button id="deployContractBtn" class="btn" style="padding: 8px 16px; min-width: auto; background: #28a745; color: white;">éƒ¨ç½²</button>
          </div>
        </div>
        <div class="info-row">
          <span class="info-label">åˆçº¦çŠ¶æ€:</span>
          <span class="info-value" id="contractStatus">æœªéªŒè¯</span>
        </div>
        <div class="info-row">
          <span class="info-label">ç½‘ç»œçŠ¶æ€:</span>
          <span class="info-value" id="networkStatus">æœªè¿æ¥</span>
        </div>
      </div>

      <!-- åˆçº¦äº¤äº’åŒºåŸŸ -->
      <div class="section">
        <h2>åˆçº¦äº¤äº’</h2>
        <div class="value-display">
          <div style="font-size: 0.5em; color: #6c757d; margin-bottom: 10px;">å½“å‰å€¼</div>
          <div id="currentValue">-</div>
        </div>
        
        <div class="button-group">
          <button id="incrementBtn" class="btn btn-primary">Increment</button>
          <button id="setNumberBtn" class="btn btn-secondary">Set Number</button>
        </div>
        
        <div class="input-group">
          <input type="number" id="numberInput" placeholder="è¾“å…¥è¦è®¾ç½®çš„æ•°å­—" value="100">
        </div>
      </div>

      <!-- äº‹ä»¶æ—¥å¿—åŒºåŸŸ -->
      <div class="section">
        <h2>äº‹ä»¶æ—¥å¿—</h2>
        <div id="eventLog"></div>
      </div>
    </div>
  </div>

  <script>
    // å®Œæ•´çš„ CounterDemo ABI
    const counterAbi = [
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "user", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "newValue", "type": "uint256"}
        ],
        "name": "Incremented",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "user", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "newValue", "type": "uint256"}
        ],
        "name": "SetNumber",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "getNumber",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "increment",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "number",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "newNumber", "type": "uint256"}],
        "name": "setNumber",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    
    // åˆçº¦å­—èŠ‚ç ï¼ˆç”¨äºéƒ¨ç½²ï¼‰
    const contractBytecode = "0x6080604052348015600e575f5ffd5b506102af8061001c5f395ff3fe608060405234801561000f575f5ffd5b506004361061004a575f3560e01c80633fb5c1cb1461004e5780638381f58a1461006a578063d09de08a14610088578063f2c9ecd814610092575b5f5ffd5b610068600480360381019061006391906101b2565b6100b0565b005b610072610107565b60405161007f91906101ec565b60405180910390f35b61009061010c565b005b61009a610173565b6040516100a791906101ec565b60405180910390f35b805f819055503373ffffffffffffffffffffffffffffffffffffffff167f73f2f3581b2f837eb0a0b85fe0e886ca0b8bb70de4750678139d3608f54098b1826040516100fc91906101ec565b60405180910390a250565b5f5481565b5f5f81548092919061011d90610232565b91905055503373ffffffffffffffffffffffffffffffffffffffff167f38ac789ed44572701765277c4d0970f2db1c1a571ed39e84358095ae4eaa54205f5460405161016991906101ec565b60405180910390a2565b5f5f54905090565b5f5ffd5b5f819050919050565b6101918161017f565b811461019b575f5ffd5b50565b5f813590506101ac81610188565b92915050565b5f602082840312156101c7576101c661017b565b5b5f6101d48482850161019e565b91505092915050565b6101e68161017f565b82525050565b5f6020820190506101ff5f8301846101dd565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61023c8261017f565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361026e5761026d610205565b5b60018201905091905056fea2646970667358221220efbb38ba8ffca59e37211b025483f8a923a03e59d0a3f0faded727d79daa9d4364736f6c634300081c0033";
    
    let provider, signer, contract, account;
    let currentContractAddress = '';
    
    // æ£€æµ‹MetaMaskæ˜¯å¦å¯ç”¨
    function isMetaMaskInstalled() {
      // æ£€æŸ¥ window.ethereum æ˜¯å¦å­˜åœ¨
      if (typeof window.ethereum === 'undefined') {
        console.log('window.ethereum æœªå®šä¹‰');
        return false;
      }
      
      console.log('window.ethereum å­˜åœ¨:', window.ethereum);
      console.log('window.ethereum.isMetaMask:', window.ethereum.isMetaMask);
      console.log('window.ethereum.providers:', window.ethereum.providers);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ MetaMask
      if (window.ethereum.isMetaMask) {
        console.log('æ£€æµ‹åˆ° MetaMask (isMetaMask = true)');
        return true;
      }
      
      // æ£€æŸ¥ providers æ•°ç»„ä¸­æ˜¯å¦æœ‰ MetaMask
      if (window.ethereum.providers && Array.isArray(window.ethereum.providers)) {
        const hasMetaMask = window.ethereum.providers.some(p => p.isMetaMask);
        console.log('providers ä¸­æ˜¯å¦æœ‰ MetaMask:', hasMetaMask);
        if (hasMetaMask) return true;
      }
      
      // å¦‚æœåªæœ‰ window.ethereumï¼Œä¹Ÿè®¤ä¸ºå¯èƒ½æ˜¯ MetaMaskï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
      // ä½†éœ€è¦è¿›ä¸€æ­¥éªŒè¯
      console.log('ä½¿ç”¨å…¼å®¹æ€§æ£€æµ‹ï¼Œå‡è®¾æ˜¯ MetaMask');
      return true;
    }
    
    // è·å–MetaMask provider
    function getMetaMaskProvider() {
      if (!window.ethereum) {
        return null;
      }
      
      // å¦‚æœæœ‰å¤šä¸ª providersï¼Œæ‰¾ MetaMask
      if (window.ethereum.providers && Array.isArray(window.ethereum.providers)) {
        return window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum;
      }
      
      return window.ethereum;
    }
    
    // åˆå§‹åŒ–
    function init() {
      const connectBtn = document.getElementById('connectBtn');
      const fileProtocolWarning = document.getElementById('fileProtocolWarning');
      
      // æ£€æŸ¥æ˜¯å¦é€šè¿‡ file:// åè®®è®¿é—®
      if (window.location.protocol === 'file:') {
        // æ˜¾ç¤ºè­¦å‘Š
        fileProtocolWarning.style.display = 'block';
        addLog('æ£€æµ‹åˆ° file:// åè®®ï¼ŒMetaMask æ— æ³•å·¥ä½œï¼', 'error');
        addLog('å¿…é¡»ä½¿ç”¨ HTTP æœåŠ¡å™¨è¿è¡Œï¼ˆlocalhostï¼‰', 'error');
        connectBtn.disabled = true;
        connectBtn.textContent = 'è¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ';
        connectBtn.style.background = '#dc3545';
        return; // ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­æ£€æµ‹
      }
      
      // å¤šæ¬¡å°è¯•æ£€æµ‹ï¼Œå› ä¸º MetaMask æ³¨å…¥å¯èƒ½éœ€è¦æ—¶é—´
      let attempts = 0;
      const maxAttempts = 20; // å¢åŠ å°è¯•æ¬¡æ•°
      
      function tryDetect() {
        attempts++;
        
        // è¯¦ç»†æ—¥å¿—
        console.log(`å°è¯•æ£€æµ‹ MetaMask (ç¬¬ ${attempts} æ¬¡)...`);
        console.log('window.ethereum:', window.ethereum);
        console.log('typeof window.ethereum:', typeof window.ethereum);
        
        if (isMetaMaskInstalled()) {
          console.log('MetaMask å·²æ£€æµ‹åˆ° (å°è¯• ' + attempts + ' æ¬¡)');
          addLog('MetaMask å·²æ£€æµ‹åˆ°', 'success');
          connectBtn.textContent = 'ğŸ¦Š è¿æ¥MetaMask';
          connectBtn.disabled = false;
          
          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
          const newBtn = connectBtn.cloneNode(true);
          connectBtn.parentNode.replaceChild(newBtn, connectBtn);
          
          // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
          document.getElementById('connectBtn').addEventListener('click', connectMetaMask);
          
          // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥
          checkConnection();
          
          // æ›´æ–°ç½‘ç»œçŠ¶æ€
          updateNetworkStatus();
        } else if (attempts < maxAttempts) {
          // ç»§ç»­å°è¯•
          setTimeout(tryDetect, 300);
        } else {
          // æœ€ç»ˆæ£€æµ‹å¤±è´¥
          console.log('MetaMask æœªæ£€æµ‹åˆ° (å·²å°è¯• ' + maxAttempts + ' æ¬¡)');
          console.log('window.ethereum:', typeof window.ethereum);
          addLog('X MetaMask æœªæ£€æµ‹åˆ°ï¼Œè¯·ç¡®ä¿ï¼š', 'error');
          addLog('1. MetaMask æ‰©å±•å·²å®‰è£…å¹¶å¯ç”¨', 'info');
          addLog('2. åˆ·æ–°é¡µé¢æˆ–é‡å¯æµè§ˆå™¨', 'info');
          addLog('3. ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼ˆä¸è¦ç›´æ¥ç”¨ file:// æ‰“å¼€ï¼‰', 'info');
          
          connectBtn.textContent = 'ğŸ¦Š å®‰è£…MetaMask';
          connectBtn.disabled = false;
          connectBtn.addEventListener('click', () => {
            window.open('https://metamask.io/download/', '_blank');
          });
        }
      }
      
      // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
      setTimeout(() => {
        tryDetect();
      }, 500);
      
      // ä¹Ÿç›‘å¬ ethereum æ³¨å…¥äº‹ä»¶
      window.addEventListener('ethereum#initialized', () => {
        console.log('MetaMask å·²æ³¨å…¥ (é€šè¿‡äº‹ä»¶)');
        addLog('æ£€æµ‹åˆ° MetaMask æ³¨å…¥äº‹ä»¶', 'success');
        tryDetect();
      }, { once: true });
      
      // ç›‘å¬ window.ethereum çš„å˜åŒ–
      let ethereumCheckInterval = setInterval(() => {
        if (typeof window.ethereum !== 'undefined') {
          console.log('æ£€æµ‹åˆ° window.ethereum å‡ºç°');
          clearInterval(ethereumCheckInterval);
          tryDetect();
        }
      }, 500);
      
      // 10ç§’ååœæ­¢æ£€æŸ¥
      setTimeout(() => {
        clearInterval(ethereumCheckInterval);
      }, 10000);
    }
    
    // æ›´æ–°ç½‘ç»œçŠ¶æ€
    async function updateNetworkStatus() {
      if (!isMetaMaskInstalled()) {
        document.getElementById('networkStatus').textContent = 'æœªè¿æ¥';
        return;
      }
      
      try {
        const ethereum = getMetaMaskProvider();
        if (!ethereum) {
          document.getElementById('networkStatus').textContent = 'æœªè¿æ¥';
          return;
        }
        
        const chainId = await ethereum.request({ method: 'eth_chainId' });
        const networkId = parseInt(chainId, 16);
        
        let networkName = 'Unknown';
        if (networkId === 1) networkName = 'Ethereum Mainnet';
        else if (networkId === 5) networkName = 'Goerli';
        else if (networkId === 11155111) networkName = 'Sepolia';
        else if (networkId === 31337) networkName = 'Hardhat Local';
        else networkName = `Chain ID: ${networkId}`;
        
        document.getElementById('networkStatus').textContent = networkName;
      } catch (error) {
        console.error('è·å–ç½‘ç»œçŠ¶æ€å¤±è´¥:', error);
        document.getElementById('networkStatus').textContent = 'è·å–å¤±è´¥';
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥
    async function checkConnection() {
      if (!isMetaMaskInstalled()) return;
      
      try {
        const ethereum = getMetaMaskProvider();
        if (!ethereum) return;
        
        const accounts = await ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          // å·²ç»è¿æ¥ï¼Œè‡ªåŠ¨è¿æ¥
          console.log('æ£€æµ‹åˆ°å·²è¿æ¥çš„è´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥...');
          await connectMetaMask();
        }
      } catch (error) {
        console.log('æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥:', error);
      }
    }
    
    // è¿æ¥MetaMask
    async function connectMetaMask() {
      const connectBtn = document.getElementById('connectBtn');
      const accountInfo = document.getElementById('accountInfo');
      
      // å†æ¬¡æ£€æµ‹ MetaMask
      if (!isMetaMaskInstalled()) {
        alert('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·ç¡®ä¿å·²å®‰è£…å¹¶å¯ç”¨æ‰©å±•ç¨‹åº');
        window.open('https://metamask.io/download/', '_blank');
        return;
      }
      
      const ethereum = getMetaMaskProvider();
      if (!ethereum) {
        alert('æ— æ³•è·å– MetaMask provider');
        return;
      }
      
      try {
        connectBtn.textContent = 'è¿æ¥ä¸­...';
        connectBtn.disabled = true;
        connectBtn.classList.add('loading');
        
        // è¯·æ±‚è´¦æˆ·è®¿é—®æƒé™ï¼ˆè¿™ä¼šå¼¹å‡ºMetaMaskå¼¹çª—ï¼‰
        await ethereum.request({ method: 'eth_requestAccounts' });
        
        provider = new ethers.BrowserProvider(ethereum);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        
        // æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
        accountInfo.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span>å·²è¿æ¥è´¦æˆ·</span>
            <span class="status-badge status-connected">å·²è¿æ¥</span>
          </div>
          <div style="margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.9em; word-break: break-all;">
            ${account}
          </div>
        `;
        accountInfo.classList.add('connected');
        accountInfo.style.display = 'block';
        
        connectBtn.textContent = 'å·²è¿æ¥';
        connectBtn.disabled = true;
        connectBtn.classList.remove('loading');
        
        // è·å–åˆçº¦åœ°å€å¹¶åˆ›å»ºåˆçº¦å®ä¾‹
        await loadContract();
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€
        await updateNetworkStatus();
        
        addLog('MetaMask è¿æ¥æˆåŠŸ', 'success');
        
      } catch (error) {
        connectBtn.textContent = 'ğŸ¦Š è¿æ¥MetaMask';
        connectBtn.disabled = false;
        connectBtn.classList.remove('loading');
        
        if (error.code === 4001) {
          addLog('X ç”¨æˆ·æ‹’ç»è¿æ¥', 'error');
          alert('æ‚¨æ‹’ç»äº†è¿æ¥è¯·æ±‚');
        } else {
          console.error('è¿æ¥å¤±è´¥:', error);
          addLog('X è¿æ¥å¤±è´¥: ' + error.message, 'error');
          alert('è¿æ¥å¤±è´¥: ' + error.message);
        }
      }
    }
    
    // æ›´æ–°å½“å‰å€¼
    async function updateValue() {
      if (!contract) return;
      try {
        const value = await contract.getNumber();
        document.getElementById('currentValue').textContent = value.toString();
      } catch (error) {
        console.error('è¯»å–å€¼å¤±è´¥:', error);
        addLog('X è¯»å–å€¼å¤±è´¥: ' + error.message, 'error');
        document.getElementById('currentValue').textContent = 'é”™è¯¯';
      }
    }
    
    // IncrementæŒ‰é’®
    document.getElementById('incrementBtn').addEventListener('click', async () => {
      if (!contract) {
        alert('è¯·å…ˆè¿æ¥MetaMask');
        return;
      }
      
      const btn = document.getElementById('incrementBtn');
      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';
      
      try {
        const tx = await contract.increment();
        addLog(`äº¤æ˜“å·²å‘é€: ${tx.hash}`, 'info');
        const receipt = await tx.wait();
        if (receipt) {
          addLog(`äº¤æ˜“ç¡®è®¤ï¼ŒåŒºå—å·: ${receipt.blockNumber}`, 'success');
        }
        await updateValue();
      } catch (error) {
        if (error.code === 4001) {
          addLog('X ç”¨æˆ·æ‹’ç»äº¤æ˜“', 'error');
        } else {
          addLog('X äº¤æ˜“å¤±è´¥: ' + error.message, 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Increment';
      }
    });
    
    // Set NumberæŒ‰é’®
    document.getElementById('setNumberBtn').addEventListener('click', async () => {
      if (!contract) {
        alert('è¯·å…ˆè¿æ¥MetaMask');
        return;
      }
      
      const number = document.getElementById('numberInput').value;
      if (!number) {
        alert('è¯·è¾“å…¥æ•°å­—');
        return;
      }
      
      const btn = document.getElementById('setNumberBtn');
      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';
      
      try {
        const tx = await contract.setNumber(number);
        addLog(`äº¤æ˜“å·²å‘é€: ${tx.hash}`, 'info');
        const receipt = await tx.wait();
        if (receipt) {
          addLog(`äº¤æ˜“ç¡®è®¤ï¼ŒåŒºå—å·: ${receipt.blockNumber}`, 'success');
        }
        await updateValue();
      } catch (error) {
        if (error.code === 4001) {
          addLog('X ç”¨æˆ·æ‹’ç»äº¤æ˜“', 'error');
        } else {
          addLog('X äº¤æ˜“å¤±è´¥: ' + error.message, 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Set Number';
      }
    });
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      if (!contract) return;
      
      contract.on('Incremented', (user, newValue, event) => {
        addLog(`Incrementedäº‹ä»¶: ç”¨æˆ· ${user} æ–°å€¼ ${newValue.toString()}`, 'event');
      });
      
      contract.on('SetNumber', (user, newValue, event) => {
        addLog(`SetNumberäº‹ä»¶: ç”¨æˆ· ${user} æ–°å€¼ ${newValue.toString()}`, 'event');
      });
    }
    
    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const log = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      let color = '#d4d4d4';
      if (type === 'success') color = '#4caf50';
      else if (type === 'error') color = '#f44336';
      else if (type === 'event') color = '#ff9800';
      else if (type === 'info') color = '#2196f3';
      
      logEntry.innerHTML = `<span class="log-time">[${time}]</span><span style="color: ${color}">${message}</span>`;
      log.appendChild(logEntry);
      log.scrollTop = log.scrollHeight;
    }
    
    // ç›‘å¬è´¦æˆ·å˜åŒ–ï¼ˆå»¶è¿Ÿè®¾ç½®ï¼Œç­‰å¾… ethereum æ³¨å…¥ï¼‰
    function setupEthereumListeners() {
      if (typeof window.ethereum === 'undefined') {
        // å¦‚æœè¿˜æ²¡æ³¨å…¥ï¼Œå»¶è¿Ÿå†è¯•
        setTimeout(setupEthereumListeners, 500);
        return;
      }
      
      const ethereum = getMetaMaskProvider();
      if (!ethereum) return;
      
      ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          addLog('è´¦æˆ·å·²æ–­å¼€', 'error');
          location.reload();
        } else {
          addLog('è´¦æˆ·å·²åˆ‡æ¢', 'info');
          location.reload();
        }
      });
      
      ethereum.on('chainChanged', () => {
        addLog('ç½‘ç»œå·²åˆ‡æ¢', 'info');
        location.reload();
      });
    }
    
    setupEthereumListeners();
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // æ·»åŠ æ¬¢è¿æ—¥å¿—
    addLog('åº”ç”¨å·²å¯åŠ¨ï¼Œç­‰å¾…è¿æ¥ MetaMask...', 'info');
    
    // éªŒè¯åˆçº¦
    async function verifyContract(address) {
      if (!provider || !address) {
        document.getElementById('contractStatus').textContent = 'æœªéªŒè¯';
        return false;
      }
      
      try {
        document.getElementById('contractStatus').textContent = 'éªŒè¯ä¸­...';
        
        // æ£€æŸ¥åœ°å€æ˜¯å¦æœ‰ä»£ç 
        const code = await provider.getCode(address);
        if (code === '0x' || code === '0x0') {
          document.getElementById('contractStatus').textContent = 'åœ°å€æ— åˆçº¦';
          addLog('X åˆçº¦åœ°å€ä¸å­˜åœ¨æˆ–æœªéƒ¨ç½²', 'error');
          return false;
        }
        
        // å°è¯•åˆ›å»ºåˆçº¦å®ä¾‹å¹¶è°ƒç”¨æ–¹æ³•
        const testContract = new ethers.Contract(address, counterAbi, provider);
        const value = await testContract.getNumber();
        
        document.getElementById('contractStatus').textContent = 'å·²éªŒè¯';
        document.getElementById('contractStatus').style.color = '#28a745';
        addLog(`åˆçº¦éªŒè¯æˆåŠŸï¼Œå½“å‰å€¼: ${value.toString()}`, 'success');
        return true;
      } catch (error) {
        document.getElementById('contractStatus').textContent = 'X éªŒè¯å¤±è´¥';
        document.getElementById('contractStatus').style.color = '#dc3545';
        addLog('X åˆçº¦éªŒè¯å¤±è´¥: ' + error.message, 'error');
        return false;
      }
    }
    
    // éƒ¨ç½²åˆçº¦
    async function deployContract() {
      if (!signer) {
        alert('è¯·å…ˆè¿æ¥ MetaMask');
        return;
      }
      
      const deployBtn = document.getElementById('deployContractBtn');
      const addressInput = document.getElementById('contractAddressInput');
      
      try {
        deployBtn.disabled = true;
        deployBtn.textContent = 'éƒ¨ç½²ä¸­...';
        
        addLog('å¼€å§‹éƒ¨ç½²åˆçº¦...', 'info');
        
        // ä½¿ç”¨ ContractFactory éƒ¨ç½²
        const factory = new ethers.ContractFactory(counterAbi, contractBytecode, signer);
        const deployedContract = await factory.deploy();
        await deployedContract.waitForDeployment();
        
        const address = await deployedContract.getAddress();
        addressInput.value = address;
        currentContractAddress = address;
        
        addLog(`åˆçº¦éƒ¨ç½²æˆåŠŸï¼Œåœ°å€: ${address}`, 'success');
        
        // åˆ›å»ºåˆçº¦å®ä¾‹
        contract = deployedContract;
        
        // è¯»å–åˆå§‹å€¼
        await updateValue();
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupEventListeners();
        
        // éªŒè¯åˆçº¦
        await verifyContract(address);
        
      } catch (error) {
        addLog('X éƒ¨ç½²å¤±è´¥: ' + error.message, 'error');
        alert('éƒ¨ç½²å¤±è´¥: ' + error.message);
      } finally {
        deployBtn.disabled = false;
        deployBtn.textContent = 'éƒ¨ç½²';
      }
    }
    
    // åŠ è½½åˆçº¦
    async function loadContract() {
      const addressInput = document.getElementById('contractAddressInput');
      const address = addressInput.value.trim();
      
      if (!address) {
        addLog('åˆçº¦åœ°å€ä¸ºç©ºï¼Œè¯·éƒ¨ç½²æˆ–è¾“å…¥åœ°å€', 'error');
        return;
      }
      
      if (!ethers.isAddress(address)) {
        addLog('X æ— æ•ˆçš„åˆçº¦åœ°å€', 'error');
        document.getElementById('contractStatus').textContent = 'åœ°å€æ— æ•ˆ';
        return;
      }
      
      currentContractAddress = address;
      
      try {
        // åˆ›å»ºåˆçº¦å®ä¾‹
        contract = new ethers.Contract(address, counterAbi, signer);
        
        // éªŒè¯åˆçº¦
        const isValid = await verifyContract(address);
        
        if (isValid) {
          // è¯»å–åˆå§‹å€¼
          await updateValue();
          
          // è®¾ç½®äº‹ä»¶ç›‘å¬
          setupEventListeners();
        }
      } catch (error) {
        addLog('X åŠ è½½åˆçº¦å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ç»‘å®šéªŒè¯å’Œéƒ¨ç½²æŒ‰é’®
    document.getElementById('verifyContractBtn').addEventListener('click', async () => {
      if (!provider) {
        alert('è¯·å…ˆè¿æ¥ MetaMask');
        return;
      }
      
      const address = document.getElementById('contractAddressInput').value.trim();
      if (!address) {
        alert('è¯·è¾“å…¥åˆçº¦åœ°å€');
        return;
      }
      
      await verifyContract(address);
    });
    
    document.getElementById('deployContractBtn').addEventListener('click', deployContract);
    
    // ç›‘å¬åœ°å€è¾“å…¥æ¡†å˜åŒ–
    document.getElementById('contractAddressInput').addEventListener('change', async () => {
      if (contract) {
        await loadContract();
      }
    });
  </script>
</body>
</html>
